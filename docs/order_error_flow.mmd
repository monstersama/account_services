%%{init: {'theme': 'base', 'themeVariables': {'background': '#ffffff', 'textColor': '#111827', 'lineColor': '#374151', 'fontSize': '18px', 'fontFamily': '"Microsoft YaHei","PingFang SC","Noto Sans SC",sans-serif', 'edgeLabelBackground': '#ffffff'}}}%%
%% 错误处理流程图
graph LR
    Error[错误发生] --> ErrorType{错误类型}

    ErrorType -->|风控拒绝| RiskReject[更新状态为<br/>RiskControllerRejected]
    ErrorType -->|交易进程拒绝| TraderReject[更新状态为<br/>TraderRejected]
    ErrorType -->|交易进程错误| TraderError[更新状态为<br/>TraderError]
    ErrorType -->|柜台拒绝| BrokerReject[更新状态为<br/>BrokerRejected]
    ErrorType -->|市场拒绝| MarketReject[更新状态为<br/>MarketRejected]

    RiskReject --> Log1[记录错误日志<br/>包含拒绝原因]
    TraderReject --> Log2[记录错误日志<br/>包含错误代码]
    TraderError --> Log3[记录错误日志<br/>包含异常信息]
    BrokerReject --> Log4[记录错误日志<br/>包含柜台错误码]
    MarketReject --> Log5[记录错误日志<br/>包含市场错误码]

    Log1 --> Notify1[通知上游策略<br/>通过共享内存]
    Log2 --> Notify2[通知上游策略<br/>通过共享内存]
    Log3 --> Notify3[通知上游策略<br/>通过共享内存]
    Log4 --> Notify4[通知上游策略<br/>通过共享内存]
    Log5 --> Notify5[通知上游策略<br/>通过共享内存]

    Notify1 --> Cleanup1[清理资源<br/>解冻资金/持仓]
    Notify2 --> Cleanup2[清理资源<br/>解冻资金/持仓]
    Notify3 --> Cleanup3[清理资源<br/>解冻资金/持仓]
    Notify4 --> Cleanup4[清理资源<br/>解冻资金/持仓]
    Notify5 --> Cleanup5[清理资源<br/>解冻资金/持仓]

    Cleanup1 --> Archive1[订单归档<br/>保存到数据库]
    Cleanup2 --> Archive2[订单归档<br/>保存到数据库]
    Cleanup3 --> Archive3[订单归档<br/>保存到数据库]
    Cleanup4 --> Archive4[订单归档<br/>保存到数据库]
    Cleanup5 --> Archive5[订单归档<br/>保存到数据库]

    Archive1 --> Done1[处理完成]
    Archive2 --> Done2[处理完成]
    Archive3 --> Done3[处理完成]
    Archive4 --> Done4[处理完成]
    Archive5 --> Done5[处理完成]

    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#111827,font-size:16px
    classDef process fill:#e1f5e1,stroke:#2e7d32,stroke-width:2px,color:#111827,font-size:16px
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#111827,font-size:16px

    linkStyle default stroke:#374151,stroke-width:2px

    class ErrorType decision
    class RiskReject,TraderReject,TraderError,BrokerReject,MarketReject error
    class Log1,Log2,Log3,Log4,Log5,Notify1,Notify2,Notify3,Notify4,Notify5,Cleanup1,Cleanup2,Cleanup3,Cleanup4,Cleanup5,Archive1,Archive2,Archive3,Archive4,Archive5,Done1,Done2,Done3,Done4,Done5 process
