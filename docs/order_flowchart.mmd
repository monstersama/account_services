%%{init: {'theme': 'base', 'themeVariables': {'background': '#ffffff', 'textColor': '#111827', 'lineColor': '#374151', 'fontSize': '18px', 'fontFamily': '"Microsoft YaHei","PingFang SC","Noto Sans SC",sans-serif', 'edgeLabelBackground': '#ffffff'}}}%%
%% 订单处理流程图 - 主流程图
graph TD
    Start[策略触发订单] --> StrategySubmit[策略提交订单]

    StrategySubmit --> SHM1[写入上游共享内存<br/>order_queue]

    SHM1 --> EventLoop[事件循环处理]

    EventLoop --> OrderBook[订单簿登记<br/>生成内部订单ID]

    OrderBook --> RiskCheck{风控检查}

    RiskCheck -->|通过| RiskAccepted[风控接受<br/>冻结资金/持仓]
    RiskCheck -->|拒绝| RiskRejected[风控拒绝<br/>更新状态为RiskControllerRejected]

    RiskRejected --> EndReject[订单终止<br/>通知策略]

    RiskAccepted --> SplitCheck{需要拆单?}

    SplitCheck -->|是| Splitter[拆单器处理<br/>生成子订单]
    SplitCheck -->|否| Router[订单路由器]

    Splitter --> Router

    Router --> SHM2[写入下游共享内存<br/>发送到交易进程]

    SHM2 --> TraderProcess[交易进程处理]

    TraderProcess --> BrokerCheck{柜台检查}

    BrokerCheck -->|接受| MarketCheck{市场检查}
    BrokerCheck -->|拒绝| BrokerReject[柜台拒绝<br/>更新状态为BrokerRejected]

    BrokerReject --> EndReject2[订单终止<br/>通知策略]

    MarketCheck -->|接受| MarketAccepted[市场接受<br/>进入撮合队列]
    MarketCheck -->|拒绝| MarketReject[市场拒绝<br/>更新状态为MarketRejected]

    MarketReject --> EndReject3[订单终止<br/>通知策略]

    MarketAccepted --> Matching[市场撮合]

    Matching --> TradeResponse[成交回报]

    TradeResponse --> SHM3[写入下游共享内存<br/>response_queue]

    SHM3 --> EventLoop2[事件循环处理成交]

    EventLoop2 --> UpdateOrder[更新订单状态<br/>成交数量/金额]

    UpdateOrder --> PositionUpdate[更新持仓管理器]

    PositionUpdate --> CompleteCheck{"订单完成?<br/>(volume_traded >= volume_entrust)"}

    CompleteCheck -->|是| OrderFinished[订单完成<br/>状态更新为Finished<br/>归档]
    CompleteCheck -->|否| WaitMore[等待更多成交]

    WaitMore --> Matching

    OrderFinished --> End[订单生命周期结束]

    classDef normal fill:#e1f5e1,stroke:#2e7d32,stroke-width:2px,color:#111827,font-size:16px
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#111827,font-size:16px
    classDef reject fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#111827,font-size:16px
    classDef external fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#111827,font-size:16px

    linkStyle default stroke:#374151,stroke-width:2px

    class Start,StrategySubmit,SHM1,EventLoop,OrderBook,RiskAccepted,Splitter,Router,SHM2,TraderProcess,MarketAccepted,Matching,TradeResponse,SHM3,EventLoop2,UpdateOrder,PositionUpdate,OrderFinished,End normal
    class RiskCheck,SplitCheck,BrokerCheck,MarketCheck,CompleteCheck decision
    class RiskRejected,EndReject,BrokerReject,EndReject2,MarketReject,EndReject3 reject
    class SHM1,SHM2,SHM3 external
